name: deploy
on:
    push:
        branches:
            - main

jobs:
    test:
        if: github.event_name == 'push'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - run: |
                  # trigger the tests here
    deploy-to-prod:
        if: github.ref == 'refs/heads/main'
        needs: [test]
        name: deploy CDK stacks to prod
        runs-on: ubuntu-latest
        permissions:
            actions: write
            contents: read
            id-token: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v2
              with:
                  role-to-assume: arn:aws:iam::871600132779:role/DevopsStack-DeploymentRoleC7BBCF2C-2U2BLZBBIYPB
                  aws-region: us-east-1

            - uses: actions/setup-node@v3
              with:
                  node-version: "16"

            - name: Install Node Packages
              run: npm i
              working-directory: ./frontend

            - name: Build Astro Site
              run: npm run build
              working-directory: ./frontend

            - name: Install SSR modules
              run: |
                  mkdir ./dist/server/node_modules
                  cp -r node_modules/undici  ./dist/server/node_modules
                  cp -r node_modules/send  ./dist/server/node_modules
                  cp -r node_modules/server-destroy  ./dist/server/node_modules
                  cp -r node_modules/mime  ./dist/server/node_modules
                  cp -r node_modules/cookie  ./dist/server/node_modules
                  cp -r node_modules/kleur  ./dist/server/node_modules
                  cp -r node_modules/slash  ./dist/server/node_modules
                  cp -r node_modules/path-to-regexp  ./dist/server/node_modules
                  cp -r node_modules/tls  ./dist/server/node_modules
                  cp -r node_modules/string-width  ./dist/server/node_modules
              working-directory: ./frontend

            - name: Install Node Packages
              run: npm i
              working-directory: ./backend

            - name: CDK Synth
              uses: youyo/aws-cdk-github-actions@v2
              with:
                  cdk_subcommand: "synth"
                  cdk_stack: "*"
                  cdk_args: "--require-approval never --verbose"
                  actions_comment: false
                  debug_log: true
                  working_dir: "backend"
              env:
                  STACK_BUILD_TARGET_ACCOUNT: prod

            - name: CDK Deploy
              uses: youyo/aws-cdk-github-actions@v2
              with:
                  cdk_subcommand: "deploy"
                  cdk_stack: "*"
                  cdk_args: "--require-approval never --verbose"
                  actions_comment: false
                  debug_log: true
                  working_dir: "backend"
              env:
                  STACK_BUILD_TARGET_ACCOUNT: prod
